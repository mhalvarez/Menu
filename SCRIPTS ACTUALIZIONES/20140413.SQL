

CREATE OR REPLACE TRIGGER TH_ASNT_TRG1
BEFORE INSERT OR UPDATE
ON TH_ASNT 
REFERENCING NEW AS NEW OLD AS OLD
FOR EACH ROW
DECLARE 
vcodigo NUMBER;
vFecha DATE;
vPatNum TH_ASNT.ASNT_PAT_NUM%TYPE;
vString  VARCHAR2(50);



BEGIN
 
 -- SELECT NVL(PARA_FECHA_EXE,SYSDATE) INTO vFecha FROM TH_PARA where 
 -- PARA_EMPGRUPO_COD = :NEW.ASNT_EMPGRUPO_COD AND
 -- PARA_EMP_COD      = :NEW.ASNT_EMP_COD ;
 -- AND PARA_EMP_NUM= :NEW.ASNT_EMP_NUM;   
  
 -- SELECT NVL(PARA_PAT_NUM,'PAT0000') INTO vPatNum FROM TH_PARA where 
 -- PARA_EMPGRUPO_COD = :NEW.ASNT_EMPGRUPO_COD AND
 -- PARA_EMP_COD      = :NEW.ASNT_EMP_COD;
 --AND PARA_EMP_NUM= :NEW.ASNT_EMP_NUM;   
  
  

  IF(inserting) THEN
  
     select TH_ASNT_SEC.nextval into vcodigo from dual;

    :NEW.ASNT_LINEA := vcodigo;
   -- :NEW.ASNT_FECHA_EXE := vFecha;
   -- :NEW.ASNT_PAT_NUM := vPatNum;
    
  END IF;
  
   IF(UPDATING) THEN
  
    
   IF  :NEW.ASNT_AX_STATUS = 1 THEN
        SELECT TO_CHAR(SYSDATE, 'DD-MON-YYYY HH24:MI:SS') INTO vString FROM dual;
       :NEW.ASNT_AX_REC := 'Ok ' || vString;
    
    END IF;
    
  END IF;

EXCEPTION
WHEN others THEN
  -- Consider logging the error and then re-raise
  RAISE;

END TH_ASNT_TRG1;
/

--EJECUTAR PRIMERO ARRIBA 


UPDATE TH_PARA SET PARA_PAT_NUM = 'PAT0040';
UPDATE TH_PARA SET PARA_FECHA_BASE = '13-APR-2014';
UPDATE TH_PARA SET PARA_FECHA_EXE  = '13-APR-2014';

COMMIT;