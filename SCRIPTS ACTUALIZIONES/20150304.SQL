-- CORRER COMO USUARIO NCO   !!

CREATE OR REPLACE FORCE VIEW QWE_MULTICOBROS
(
   RECO_CODI,
   RECO_ANCI,
   RECIBO,
   RECO_DAEM,
   TIPOC,
   CONTROL,
   TACO_CODI,
   MOCO_CODI,
   DERE_VARE,
   TIMO_CODI,
   TIMO_COCO,
   MOLI_DESC,
   MOCO_DOCU,
   MOCO_DESC
)
AS
   SELECT TNCO_RECO.RECO_CODI,
          TNCO_RECO.RECO_ANCI,
          TNCO_RECO.RECO_CONS || '/' || TNCO_RECO.RECO_ANCI AS RECIBO,
          TNCO_RECO.RECO_DAEM,
          'CREDITO' AS TIPOC,
          TNCO_DERC.DERE_CODI AS CONTROL,
          TNCO_DERC.TACO_CODI,
          TNCO_DERC.MOCO_CODI,
          ROUND (TNCO_DERC.DERE_VARE, 2) AS DERE_VARE,
          TNCO_TIMO.TIMO_CODI,
          NVL (TNCO_TIMO.TIMO_COCO, '?') AS TIMO_COCO,
          NVL (TNCO_MOLI.MOLI_DESC, '?') AS MOLI_DESC,
          NVL (TNCO_MOCO.MOCO_DOCU, '?') AS MOCO_DOCU,
          NVL (TNCO_MOCO.MOCO_DESC, '?') AS MOCO_DESC
     FROM TNCO_RECO,
          TNCO_DERC,
          TNCO_MOCO,
          TNCO_TIMO,
          TNCO_MOLI
    WHERE     TNCO_RECO.RECO_CODI = TNCO_DERC.RECO_CODI
          AND TNCO_RECO.RECO_ANCI = TNCO_DERC.RECO_ANCI
          AND TNCO_DERC.TACO_CODI = TNCO_MOCO.TACO_CODI
          AND TNCO_DERC.MOCO_CODI = TNCO_MOCO.MOCO_CODI
          AND TNCO_MOCO.TIMO_CODI = TNCO_TIMO.TIMO_CODI
          AND TNCO_TIMO.TIMO_CODI = TNCO_MOLI.TIMO_CODI
          AND TNCO_MOLI.LICL_CODI = 1
          AND TNCO_RECO.RECO_TIPO = 5
          AND TNCO_RECO.HOTE_CODI = 1
   UNION
   SELECT TNCO_RECO.RECO_CODI,
          TNCO_RECO.RECO_ANCI,
          TNCO_RECO.RECO_CONS || '/' || TNCO_RECO.RECO_ANCI AS RECIBO,
          TNCO_RECO.RECO_DAEM,
          'DEBITO' AS TIPOC,
          TNCO_DERE.DERE_CODI AS CONTROL,
          TNCO_DERE.TACO_CODI,
          TNCO_DERE.MOCO_CODI,
          ROUND (TNCO_DERE.DERE_VARE, 2) AS DERE_VARE,
          TNCO_TIMO.TIMO_CODI,
          NVL (TNCO_TIMO.TIMO_COCO, '?') AS TIMO_COCO,
          NVL (TNCO_MOLI.MOLI_DESC, '?') AS MOLI_DESC,
          NVL (TNCO_MOCO.MOCO_DOCU, '?') AS MOCO_DOCU,
          NVL (TNCO_MOCO.MOCO_DESC, '?') AS MOCO_DESC
     FROM TNCO_RECO,
          TNCO_DERE,
          TNCO_MOCO,
          TNCO_TIMO,
          TNCO_MOLI
    WHERE     TNCO_RECO.RECO_CODI = TNCO_DERE.RECO_CODI(+)
          AND TNCO_RECO.RECO_ANCI = TNCO_DERE.RECO_ANCI(+)
          AND TNCO_DERE.TACO_CODI = TNCO_MOCO.TACO_CODI
          AND TNCO_DERE.MOCO_CODI = TNCO_MOCO.MOCO_CODI
          AND TNCO_MOCO.TIMO_CODI = TNCO_TIMO.TIMO_CODI
          AND TNCO_TIMO.TIMO_CODI = TNCO_MOLI.TIMO_CODI
          AND TNCO_MOLI.LICL_CODI = 1
          AND TNCO_RECO.RECO_TIPO = 5
          AND TNCO_RECO.HOTE_CODI = 1
          AND (TNCO_RECO.RECO_CODI, TNCO_RECO.RECO_ANCI) IN
                 (SELECT RECO_CODI, RECO_ANCI FROM TNCO_DERC)
   ORDER BY RECO_DAEM,
            RECIBO,
            CONTROL,
            TIPOC;


CREATE OR REPLACE FORCE VIEW QWE_COBROS_RECIBO
(
   RECO_CODI,
   RECO_ANCI,
   RECO_CONS,
   RECO_DAEM,
   ORIGEN,
   DERE_CODI,
   DERE_TIPO,
   TACO_CODI,
   MOCO_CODI,
   DERE_VARE,
   TIMO_CODI,
   TIMO_COCO,
   MOLI_DESC,
   MOCO_DOCU,
   MOCO_DESC,
   HOTE_CODI
)
AS
   SELECT TNCO_RECO.RECO_CODI,
          TNCO_RECO.RECO_ANCI,
          TNCO_RECO.RECO_CONS,
          TNCO_RECO.RECO_DAEM,
          'DERC ' AS ORIGEN,
          TNCO_DERC.DERE_CODI,
          TNCO_DERC.DERE_TIPO,
          TNCO_DERC.TACO_CODI,
          TNCO_DERC.MOCO_CODI,
          TNCO_DERC.DERE_VARE,
          TNCO_TIMO.TIMO_CODI,
          TNCO_TIMO.TIMO_COCO,
          TNCO_MOLI.MOLI_DESC,
          TNCO_MOCO.MOCO_DOCU,
          TNCO_MOCO.MOCO_DESC,
          TNCO_RECO.HOTE_CODI
     FROM TNCO_RECO,
          TNCO_DERC,
          TNCO_MOCO,
          TNCO_TIMO,
          TNCO_MOLI
    WHERE     TNCO_RECO.RECO_CODI = TNCO_DERC.RECO_CODI(+)
          AND TNCO_RECO.RECO_ANCI = TNCO_DERC.RECO_ANCI(+)
          AND TNCO_DERC.TACO_CODI = TNCO_MOCO.TACO_CODI
          AND TNCO_DERC.MOCO_CODI = TNCO_MOCO.MOCO_CODI
          AND TNCO_MOCO.TIMO_CODI = TNCO_TIMO.TIMO_CODI
          AND TNCO_TIMO.TIMO_CODI = TNCO_MOLI.TIMO_CODI
          AND TNCO_MOLI.LICL_CODI = 1
          AND RECO_TIPO = 5
   UNION ALL
   SELECT TNCO_RECO.RECO_CODI,
          TNCO_RECO.RECO_ANCI,
          TNCO_RECO.RECO_CONS,
          TNCO_RECO.RECO_DAEM,
          'DERE' AS ORIGEN,
          TNCO_DERE.DERE_CODI,
          TNCO_DERE.DERE_TIPO,
          TNCO_RECO.TACO_CODI,
          TNCO_RECO.MOCO_CODI,
          TNCO_DERE.DERE_VARE,
          TNCO_TIMO.TIMO_CODI,
          TNCO_TIMO.TIMO_COCO,
          TNCO_MOLI.MOLI_DESC,
          TNCO_MOCO.MOCO_DOCU,
          TNCO_MOCO.MOCO_DESC,
          TNCO_RECO.HOTE_CODI
     FROM TNCO_RECO,
          TNCO_DERE,
          TNCO_MOCO,
          TNCO_TIMO,
          TNCO_MOLI
    WHERE     TNCO_RECO.RECO_CODI = TNCO_DERE.RECO_CODI(+)
          AND TNCO_RECO.RECO_ANCI = TNCO_DERE.RECO_ANCI(+)
          AND TNCO_RECO.TACO_CODI = TNCO_MOCO.TACO_CODI
          AND TNCO_RECO.MOCO_CODI = TNCO_MOCO.MOCO_CODI
          AND TNCO_MOCO.TIMO_CODI = TNCO_TIMO.TIMO_CODI
          AND TNCO_TIMO.TIMO_CODI = TNCO_MOLI.TIMO_CODI
          AND TNCO_MOLI.LICL_CODI = 1
          AND RECO_TIPO = 5
          AND (TNCO_RECO.RECO_CODI, TNCO_RECO.RECO_ANCI) NOT IN
                 (SELECT RECO_CODI, RECO_ANCI FROM TNCO_DERC)
   ORDER BY RECO_DAEM, RECO_CONS;


-- CORRER COMO INTEGRACION !!!


ALTER TABLE TC_ASNT
 ADD (ASNT_MULTICOBRO  NUMBER                       DEFAULT 0);


COMMENT ON COLUMN TC_ASNT.ASNT_MULTICOBRO IS 'Indica si es un recibo con mas de un cobro y mas de una factura';


UPDATE TH_PARA SET PARA_PAT_NUM = 'PAT0040';
UPDATE TH_PARA SET PARA_FECHA_BASE = '04-MAR-2015';
UPDATE TH_PARA SET PARA_FECHA_EXE  = '04-MAR-2015';

COMMIT;